# Stack Pointer points to a `null` value
                               
# Host environment

- `macOS Sequoia v15.5`
- `rustup v1.28.2`
- `rustc v1.88.0`
- `cargo-binutils v0.3.6`
- `probe-rs v0.29.1`
- `llvm-tools v0.1.1`
- `arm-none-eabi-binutils v2.44`
- `gcc-arm-embedded v14.3.rel1` 

# Target

Micro:bit v2.21 with nRF52833 (Cortex-M4).

![Front](images/MicroBit%20v2.2.1%20Front.jpeg)

![Back](images/MicroBit%20v2.2.1%20Back.jpeg)

# Project setup

```shell
brew install rustup gcc-arm-embedded arm-none-eabi-binutils

rustup-init
rustup target add thumbv7em-none-eabihf

cargo install cargo-binutils probe-rs
rustup component add llvm-tools
```
 
# Replication steps
                  
## The `debug` profile

1. Run `cargo build`.
2. Run `cargo size -- -A`. The following will be printed out:
   ```
       Finished `dev` profile [unoptimized + debuginfo] target(s) in 0.01s
   cortex-sp-null  :
   section               size        addr
   .vector_table         1024         0x0
   .text                19140       0x400
   .rodata               6488      0x4ec4
   .data                   16  0x20000000
   .gnu.sgstubs             0      0x6840
   .bss                  1100  0x20000010
   .uninit                  0  0x2000045c
   .debug_abbrev        13684         0x0
   .debug_info         221647         0x0
   .debug_aranges        8720         0x0
   .debug_str          316248         0x0
   .comment               153         0x0
   .ARM.attributes         58         0x0
   .debug_frame         29488         0x0
   .debug_line         168791         0x0
   .debug_ranges        85096         0x0
   .debug_loc             693         0x0
   .debug_pubnames        702         0x0
   .debug_pubtypes         71         0x0
   Total               873119
   ``` 
3. Run `cargo objdump -- -s --section .vector_table`:
   ```
       Finished `dev` profile [unoptimized + debuginfo] target(s) in 0.01s

   cortex-sp-null:	file format elf32-littlearm
   Contents of section .vector_table:
    0000 00000220 01040000 c3380000 bd4e0000  ... .....8...N..
    0010 c3380000 c3380000 c3380000 00000000  .8...8...8......
    0020 00000000 00000000 00000000 c3380000  .............8..
    0030 c3380000 00000000 c3380000 c3380000  .8.......8...8..
    0040 c3380000 c3380000 c3380000 c3380000  .8...8...8...8..
    0050 c3380000 c3380000 c3380000 c3380000  .8...8...8...8..
    0060 c3380000 c3380000 c3380000 c3380000  .8...8...8...8..
    0070 c3380000 c3380000 c3380000 c3380000  .8...8...8...8..
    0080 c3380000 c3380000 c3380000 c3380000  .8...8...8...8..
    0090 c3380000 c3380000 c3380000 c3380000  .8...8...8...8..
    00a0 c3380000 c3380000 c3380000 c3380000  .8...8...8...8..
    00b0 c3380000 c3380000 c3380000 c3380000  .8...8...8...8..
    00c0 c3380000 c3380000 c3380000 c3380000  .8...8...8...8..
    00d0 c3380000 c3380000 c3380000 c3380000  .8...8...8...8..
    00e0 c3380000 c3380000 c3380000 c3380000  .8...8...8...8..
    00f0 c3380000 c3380000 c3380000 c3380000  .8...8...8...8..
    0100 c3380000 c3380000 c3380000 c3380000  .8...8...8...8..
    0110 c3380000 c3380000 c3380000 c3380000  .8...8...8...8..
    0120 c3380000 c3380000 c3380000 c3380000  .8...8...8...8..
    0130 c3380000 c3380000 c3380000 c3380000  .8...8...8...8..
    0140 c3380000 c3380000 c3380000 c3380000  .8...8...8...8..
    0150 c3380000 c3380000 c3380000 c3380000  .8...8...8...8..
    0160 c3380000 c3380000 c3380000 c3380000  .8...8...8...8..
    0170 c3380000 c3380000 c3380000 c3380000  .8...8...8...8..
    0180 c3380000 c3380000 c3380000 c3380000  .8...8...8...8..
    0190 c3380000 c3380000 c3380000 c3380000  .8...8...8...8..
    01a0 c3380000 c3380000 c3380000 c3380000  .8...8...8...8..
    01b0 c3380000 c3380000 c3380000 c3380000  .8...8...8...8..
    01c0 c3380000 c3380000 c3380000 c3380000  .8...8...8...8..
    01d0 c3380000 c3380000 c3380000 c3380000  .8...8...8...8..
    01e0 c3380000 c3380000 c3380000 c3380000  .8...8...8...8..
    01f0 c3380000 c3380000 c3380000 c3380000  .8...8...8...8..
    0200 c3380000 c3380000 c3380000 c3380000  .8...8...8...8..
    0210 c3380000 c3380000 c3380000 c3380000  .8...8...8...8..
    0220 c3380000 c3380000 c3380000 c3380000  .8...8...8...8..
    0230 c3380000 c3380000 c3380000 c3380000  .8...8...8...8..
    0240 c3380000 c3380000 c3380000 c3380000  .8...8...8...8..
    0250 c3380000 c3380000 c3380000 c3380000  .8...8...8...8..
    0260 c3380000 c3380000 c3380000 c3380000  .8...8...8...8..
    0270 c3380000 c3380000 c3380000 c3380000  .8...8...8...8..
    0280 c3380000 c3380000 c3380000 c3380000  .8...8...8...8..
    0290 c3380000 c3380000 c3380000 c3380000  .8...8...8...8..
    02a0 c3380000 c3380000 c3380000 c3380000  .8...8...8...8..
    02b0 c3380000 c3380000 c3380000 c3380000  .8...8...8...8..
    02c0 c3380000 c3380000 c3380000 c3380000  .8...8...8...8..
    02d0 c3380000 c3380000 c3380000 c3380000  .8...8...8...8..
    02e0 c3380000 c3380000 c3380000 c3380000  .8...8...8...8..
    02f0 c3380000 c3380000 c3380000 c3380000  .8...8...8...8..
    0300 c3380000 c3380000 c3380000 c3380000  .8...8...8...8..
    0310 c3380000 c3380000 c3380000 c3380000  .8...8...8...8..
    0320 c3380000 c3380000 c3380000 c3380000  .8...8...8...8..
    0330 c3380000 c3380000 c3380000 c3380000  .8...8...8...8..
    0340 c3380000 c3380000 c3380000 c3380000  .8...8...8...8..
    0350 c3380000 c3380000 c3380000 c3380000  .8...8...8...8..
    0360 c3380000 c3380000 c3380000 c3380000  .8...8...8...8..
    0370 c3380000 c3380000 c3380000 c3380000  .8...8...8...8..
    0380 c3380000 c3380000 c3380000 c3380000  .8...8...8...8..
    0390 c3380000 c3380000 c3380000 c3380000  .8...8...8...8..
    03a0 c3380000 c3380000 c3380000 c3380000  .8...8...8...8..
    03b0 c3380000 c3380000 c3380000 c3380000  .8...8...8...8..
    03c0 c3380000 c3380000 c3380000 c3380000  .8...8...8...8..
    03d0 c3380000 c3380000 c3380000 c3380000  .8...8...8...8..
    03e0 c3380000 c3380000 c3380000 c3380000  .8...8...8...8..
    03f0 c3380000 c3380000 c3380000 c3380000  .8...8...8...8..
   ``` 
4. Run `cargo embed` to flash and start up the RTT UI. 
5. The following output will appear:
   ```
   INFO  [cortex_sp_null] Started the application
   INFO  [cortex_sp_null] SP FLASH ADDRESS: 0x00000000
   INFO  [cortex_sp_null] PC FLASH ADDRESS: 0x00000004
   ERROR [cortex_sp_null] The panic handler was called with PanicInfo: panicked at src/main.rs:43:9:
   null pointer dereference occurred
   ```
6. **Actual result:** The `info!("SP RAM ADDRESS:   {:#010X}", *sp_ptr);` causes panic
   because the `sp_ptr` points to a `null` value.
7. **Expected result:** Based on the first 32-bits in the `objdump` (`00000220`), 
   the `sp_ptr` should point to `0x2002_0000`.

## The `release` profile

1. Run `cargo build --release`.
2. Run `cargo size --release -- -A`. The following will be printed out:
   ```
       Finished `release` profile [optimized] target(s) in 0.01s
   cortex-sp-null  :
   section             size        addr
   .vector_table       1024         0x0
   .text               7624       0x400
   .rodata             1152      0x21c8
   .data                 16  0x20000000
   .gnu.sgstubs           0      0x2660
   .bss                1100  0x20000010
   .uninit                0  0x2000045c
   .comment             153         0x0
   .ARM.attributes       58         0x0
   Total              11127
   ``` 
3. Run `cargo objdump --release -- -s --section .vector_table`:
   ```
       Finished `release` profile [optimized] target(s) in 0.00s

   cortex-sp-null:	file format elf32-littlearm
   Contents of section .vector_table:
    0000 00000220 01040000 b70f0000 c1210000  ... .........!..
    0010 b70f0000 b70f0000 b70f0000 00000000  ................
    0020 00000000 00000000 00000000 b70f0000  ................
    0030 b70f0000 00000000 b70f0000 b70f0000  ................
    0040 b70f0000 b70f0000 b70f0000 b70f0000  ................
    0050 b70f0000 b70f0000 b70f0000 b70f0000  ................
    0060 b70f0000 b70f0000 b70f0000 b70f0000  ................
    0070 b70f0000 b70f0000 b70f0000 b70f0000  ................
    0080 b70f0000 b70f0000 b70f0000 b70f0000  ................
    0090 b70f0000 b70f0000 b70f0000 b70f0000  ................
    00a0 b70f0000 b70f0000 b70f0000 b70f0000  ................
    00b0 b70f0000 b70f0000 b70f0000 b70f0000  ................
    00c0 b70f0000 b70f0000 b70f0000 b70f0000  ................
    00d0 b70f0000 b70f0000 b70f0000 b70f0000  ................
    00e0 b70f0000 b70f0000 b70f0000 b70f0000  ................
    00f0 b70f0000 b70f0000 b70f0000 b70f0000  ................
    0100 b70f0000 b70f0000 b70f0000 b70f0000  ................
    0110 b70f0000 b70f0000 b70f0000 b70f0000  ................
    0120 b70f0000 b70f0000 b70f0000 b70f0000  ................
    0130 b70f0000 b70f0000 b70f0000 b70f0000  ................
    0140 b70f0000 b70f0000 b70f0000 b70f0000  ................
    0150 b70f0000 b70f0000 b70f0000 b70f0000  ................
    0160 b70f0000 b70f0000 b70f0000 b70f0000  ................
    0170 b70f0000 b70f0000 b70f0000 b70f0000  ................
    0180 b70f0000 b70f0000 b70f0000 b70f0000  ................
    0190 b70f0000 b70f0000 b70f0000 b70f0000  ................
    01a0 b70f0000 b70f0000 b70f0000 b70f0000  ................
    01b0 b70f0000 b70f0000 b70f0000 b70f0000  ................
    01c0 b70f0000 b70f0000 b70f0000 b70f0000  ................
    01d0 b70f0000 b70f0000 b70f0000 b70f0000  ................
    01e0 b70f0000 b70f0000 b70f0000 b70f0000  ................
    01f0 b70f0000 b70f0000 b70f0000 b70f0000  ................
    0200 b70f0000 b70f0000 b70f0000 b70f0000  ................
    0210 b70f0000 b70f0000 b70f0000 b70f0000  ................
    0220 b70f0000 b70f0000 b70f0000 b70f0000  ................
    0230 b70f0000 b70f0000 b70f0000 b70f0000  ................
    0240 b70f0000 b70f0000 b70f0000 b70f0000  ................
    0250 b70f0000 b70f0000 b70f0000 b70f0000  ................
    0260 b70f0000 b70f0000 b70f0000 b70f0000  ................
    0270 b70f0000 b70f0000 b70f0000 b70f0000  ................
    0280 b70f0000 b70f0000 b70f0000 b70f0000  ................
    0290 b70f0000 b70f0000 b70f0000 b70f0000  ................
    02a0 b70f0000 b70f0000 b70f0000 b70f0000  ................
    02b0 b70f0000 b70f0000 b70f0000 b70f0000  ................
    02c0 b70f0000 b70f0000 b70f0000 b70f0000  ................
    02d0 b70f0000 b70f0000 b70f0000 b70f0000  ................
    02e0 b70f0000 b70f0000 b70f0000 b70f0000  ................
    02f0 b70f0000 b70f0000 b70f0000 b70f0000  ................
    0300 b70f0000 b70f0000 b70f0000 b70f0000  ................
    0310 b70f0000 b70f0000 b70f0000 b70f0000  ................
    0320 b70f0000 b70f0000 b70f0000 b70f0000  ................
    0330 b70f0000 b70f0000 b70f0000 b70f0000  ................
    0340 b70f0000 b70f0000 b70f0000 b70f0000  ................
    0350 b70f0000 b70f0000 b70f0000 b70f0000  ................
    0360 b70f0000 b70f0000 b70f0000 b70f0000  ................
    0370 b70f0000 b70f0000 b70f0000 b70f0000  ................
    0380 b70f0000 b70f0000 b70f0000 b70f0000  ................
    0390 b70f0000 b70f0000 b70f0000 b70f0000  ................
    03a0 b70f0000 b70f0000 b70f0000 b70f0000  ................
    03b0 b70f0000 b70f0000 b70f0000 b70f0000  ................
    03c0 b70f0000 b70f0000 b70f0000 b70f0000  ................
    03d0 b70f0000 b70f0000 b70f0000 b70f0000  ................
    03e0 b70f0000 b70f0000 b70f0000 b70f0000  ................
    03f0 b70f0000 b70f0000 b70f0000 b70f0000  ................
   ``` 
4. Run `cargo embed --release` to flash and start up the RTT UI.
5. The following output will appear:
   ```
   INFO  [cortex_sp_null] Started the application
   INFO  [cortex_sp_null] SP FLASH ADDRESS: 0x00000000
   INFO  [cortex_sp_null] PC FLASH ADDRESS: 0x00000004
   INFO  [cortex_sp_null] SP RAM ADDRESS:   0x20020000
   INFO  [cortex_sp_null] PC RAM ADDRESS:   0x00000401
   INFO  [cortex_sp_null] Counter: 0
   INFO  [cortex_sp_null] Counter: 1
   ```
6. Based on the first 32-bits in the `objdump` (`00000220`),
   the `sp_ptr` points to `0x2002_0000` and its dereference is successful.
